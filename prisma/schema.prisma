// Prisma Schema for Invoice SaaS

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  companyName   String?
  logoUrl       String?
  address       String?
  city          String?
  state         String?
  zipCode       String?
  country       String    @default("US")
  phone         String?
  taxId         String?
  currency      String    @default("USD")

  // Stripe
  stripeCustomerId  String?
  stripeAccountId   String?  // For receiving payments

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  clients       Client[]
  invoices      Invoice[]
  emailTemplates EmailTemplate[]
}

// ============================================
// CLIENTS
// ============================================

model Client {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  email       String
  phone       String?
  company     String?
  address     String?
  city        String?
  state       String?
  zipCode     String?
  country     String    @default("US")
  notes       String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  invoices    Invoice[]

  @@unique([userId, email])
  @@index([userId])
}

// ============================================
// INVOICES
// ============================================

model Invoice {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId        String
  client          Client    @relation(fields: [clientId], references: [id])

  // Invoice Details
  invoiceNumber   String
  status          InvoiceStatus @default(DRAFT)

  // Dates
  issueDate       DateTime  @default(now())
  dueDate         DateTime?

  // Amounts
  subtotal        Decimal   @db.Decimal(10, 2)
  taxRate         Decimal?  @db.Decimal(5, 2)
  taxAmount       Decimal?  @db.Decimal(10, 2)
  discountAmount  Decimal?  @db.Decimal(10, 2)
  total           Decimal   @db.Decimal(10, 2)
  amountPaid      Decimal   @default(0) @db.Decimal(10, 2)
  currency        String    @default("USD")

  // Content
  notes           String?
  terms           String?

  // Tracking
  sentAt          DateTime?
  viewedAt        DateTime?
  paidAt          DateTime?

  // Recurring
  isRecurring     Boolean   @default(false)
  recurringInterval RecurringInterval?
  nextRecurringDate DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  lineItems       LineItem[]
  payments        Payment[]
  reminders       Reminder[]
  activities      InvoiceActivity[]

  @@unique([userId, invoiceNumber])
  @@index([userId])
  @@index([clientId])
  @@index([status])
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
}

enum RecurringInterval {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

// ============================================
// LINE ITEMS
// ============================================

model LineItem {
  id          String    @id @default(cuid())
  invoiceId   String
  invoice     Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  description String
  quantity    Decimal   @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal   @db.Decimal(10, 2)
  amount      Decimal   @db.Decimal(10, 2)
  sortOrder   Int       @default(0)

  createdAt   DateTime  @default(now())

  @@index([invoiceId])
}

// ============================================
// PAYMENTS
// ============================================

model Payment {
  id            String    @id @default(cuid())
  invoiceId     String
  invoice       Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  amount        Decimal   @db.Decimal(10, 2)
  method        PaymentMethod
  transactionId String?
  notes         String?

  paidAt        DateTime  @default(now())

  @@index([invoiceId])
}

enum PaymentMethod {
  STRIPE
  PAYPAL
  BANK_TRANSFER
  CASH
  CHECK
  OTHER
}

// ============================================
// REMINDERS
// ============================================

model Reminder {
  id          String    @id @default(cuid())
  invoiceId   String
  invoice     Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  type        ReminderType
  template    ReminderTemplate @default(FRIENDLY)
  scheduledAt DateTime
  sentAt      DateTime?

  createdAt   DateTime  @default(now())

  @@index([invoiceId])
  @@index([scheduledAt])
}

enum ReminderType {
  EMAIL
  SMS
}

enum ReminderTemplate {
  FRIENDLY
  FIRM
  FINAL
}

// ============================================
// ACTIVITY LOG
// ============================================

model InvoiceActivity {
  id          String    @id @default(cuid())
  invoiceId   String
  invoice     Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  action      ActivityAction
  metadata    Json?

  createdAt   DateTime  @default(now())

  @@index([invoiceId])
}

enum ActivityAction {
  CREATED
  UPDATED
  SENT
  VIEWED
  REMINDER_SENT
  PAYMENT_RECEIVED
  MARKED_PAID
  CANCELLED
}

// ============================================
// EMAIL TEMPLATES
// ============================================

model EmailTemplate {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  subject     String
  body        String
  isDefault   Boolean   @default(false)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
}
